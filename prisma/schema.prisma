datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  VENDOR
  CUSTOMER
}

enum AgreementStatus {
  DRAFT
  ACCEPTED
  DEPLOYED
  COMPLETED
  CANCELED
}

model User {
  id        String  @id @default(cuid())
  address   String  @unique
  role      Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  agreementsCreated  Agreement[] @relation("VendorAgreements")
  agreementsAssigned Agreement[] @relation("CustomerAgreements")
}

model Agreement {
  id        String  @id @default(cuid())
  title     String
  description String
  vendorAddress   String
  customerAddress String
  status    AgreementStatus @default(DRAFT)
  chainId   Int?
  factoryAddress String?
  contractAddress String? // filled after deploy

  // store milestone values as strings (wei) to avoid BigInt issues
  milestones Milestone[]

  vendor    User? @relation("VendorAgreements", fields: [vendorAddress], references: [address])
  customer  User? @relation("CustomerAgreements", fields: [customerAddress], references: [address])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Milestone {
  id          String  @id @default(cuid())
  agreementId String
  // amount in wei as string
  amountWei   String
  description String
  released    Boolean @default(false)
  releasedAt  DateTime?

  agreement   Agreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)
}